import { FullScreenCode, Head, Image, SplitRight } from 'mdx-deck'
import Theme from './src/index'
import { Card, SplitLeftAlign } from './src/index'
export const theme = Theme

<Head>
  <title>Moving the AgilityNerd Blog to GatsbyJS</title>
</Head>

---

# Moving the AgilityNerd Blog to GatsbyJS

## Steve Schwarz

#### NWCJS Meetup - Nov-2019

---
import stevesnap from './images/steve-snap.jpg'

<SplitRight>

<div style="position:relative">
<Image src={stevesnap} size="contain" style={{height: '90vh', marginLeft: '1em'}} title="Copyright Chops Photography"/>
<a style="position:absolute;bottom:5em;left:0;width:100%;font-size:0.5em" href="https://chopsphoto.com">Photo Copyright Chops Photography</a>
</div>

<div style="padding: 0 1em 1em 1em">

#### @steveaschwarz

<div style="text-align: left">

Software developer since 1991.

15 yrs C/C++: factory automation and futures/options trading.

12+ yrs web dev: Python, JavaScript, Angular, VueJS

20+ yrs: dog agility and web dev: [agilitynerd.com](https://www.agilitynerd.com),  [tech.agilitynerd.com](https://tech.agilitynerd.com), [googility.com](https://googility.com), [agilitycourses.com](https://agilitycourses.com) & [agilitycoursemaster.com](https://agilitycoursemaster.com)

</div>

</div>

</SplitRight>

---

import legacyagilitynerd from './images/legacy-agilitynerd.png'

<SplitLeftAlign style="width:100%">

<div style="height:100vh">
<Image src={legacyagilitynerd} size="contain"></Image>
</div>

<div style="text-align: left;padding-left:1em;">
<h3>AgilityNerd Blog</h3>
<ul>
<li>Started in 2004</li>
<li>Oldest dog agility blog</li>
<li>Hierarchical categories, tags, pages automatically cross linked</li>
<li>800 blog posts</li>
<li>1,600 total pages</li>
<li>12,000 FB followers</li>
</ul>
</div>

</SplitLeftAlign>

---

## Why Change?

1. Authoring experience so painful I don't want to blog!
2. 1990s platform requiring a VPS
3. Performance

---

## Authoring

<SplitLeftAlign style="width:90%">
<div>

  - Current:
    - Local editor
    - Flat files: metadata + HTML
    - No local preview
    - Manually optimize images
    - FTP deploy of HTML/assets, view on site and tweak

</div>
<div>

  - Desired:
    - Local and mobile editing
    - Flat files or CMS in [MDX](https://mdxjs.com/)
    - Local and mobile preview
    - Upload raw images
    - `git push` deploys site

</div>
</SplitLeftAlign>

---

## Platform

<SplitLeftAlign style="width:90%">
<div>

  - Current:
    - 1990s Perl CGI Script (Blosxom)
    - Dozens of custom plugins
    - Scripts to generate tags, etc.
    - NGINX with caching
    - Linux VPS $

</div>
<div>

  - Desired:
    - Use the latest technology
    - Static hosting
    - Zero or low cost

</div>
</SplitLeftAlign>

---

## Performance

<SplitLeftAlign style="width:90%">
<div>

  - Current:
    - Caching gives fast page load on "hot" pages
    - Images on subdomain for parallelization

</div>
<div>

  - Desired:
    - All pages fast
    - Prefetch pages
    - Responsive images
    - Offline support

</div>
</SplitLeftAlign>

---
import gatsbyicon from './images/Gatsby_Monogram.png'

<Image src={gatsbyicon} size='contain' style={{height:150}}/>

##  Gatsby JS

- Open source, MIT license: https://gatsbyjs.org
- Created by Kyle Mathews [@kylemathews](https://twitter.com/kylemathews)
- Commercial services: https://gatsbyjs.com

---
<!--
import jamstack from './images/jamstack.png'

<Image src={jamstack} size="contain" style={{height: '100vh', zIndex: 10}}/>

---

## JAMstack Provides:

- Performance: Generate all/most pages at build time
- Scaling: Stateless servers and CDNs
- Security: No server code running smaller attack surface
- Improved developer experience

https://jamstack.org

---
-->

## Gatsby "Fits the bill"

<SplitLeftAlign style="width:99%">
<div>

  - Authoring
    - Flat files or CMS in Markdown
    - Local/mobile editing
    - Hot reload/preview
    - Uploaded images optimized
    - Dynamic data updated during build
    - `git push` deploys site

</div>
<div>

  - Platform
    - Latest tech: JS, ReactJS, GraphQL
    - Static hosting - anywhere/free
  - Performance!
    - All pages fast
    - Prefetches pages/images
    - Offline support

</div>
</SplitLeftAlign>

---

# Gatsby in Action

[agilitynerd.com](https://www.agilitynerd.com)

- High Lighthouse performance scores
- Image blur up on load
- Prefetches linked content on scroll
- Progressive Web App (PWA)

---
<!--
## Gatsby:
- Combines multiple data sources
- Unified data access model: GraphQL
- Generate pages at build time
- React eco-system goodness

---
-->

import howgatsbyworks from './images/how-gatsby-works.png'

<Image src={howgatsbyworks} size="contain" style={{height: '99vh', zIndex: 10}}/>

---

## Getting Started

```
npm install -g gatsby-cli

gatsby new my-blog-starter https://github.com/gatsbyjs/gatsby-starter-blog

cd my-blog-starter

```

https://github.com/gatsbyjs/gatsby-starter-blog

---

## Create a Blog Post

```md
---
author: Steve Schwarz
date: 2019-11-07 14:00:00
description: "Here are a couple amazing photos of Snap!"
tags:
- ChopsPhotography
- journal
- Snap!
title: Photogenic Snap!
image: "/uploads/snap-field-chops-photography-2019.jpg"
---

Here are just a couple of the amazing photographs
Whitney Rupp of <MultiLink match="ChopsPhotography">Chops Photography</MultiLink>
took of <MultiLink match="Snap!">Snap!</MultiLink> this past year.





```

---

### Develop It!

```
gatsby develop
```

### Build It!

```
gatsby build
```

[What Happens When Gatsby Builds?](https://www.gatsbyjs.org/docs/overview-of-the-gatsby-build-process/#what-happens-when-you-run-gatsby-build)



---

## Data Source Plugins Provide Content

- Markdown, MDX (Markdown + JSX), YAML, CSV, JSON, etc. from files
- Content Management Systems
- Twitter, FB, GitHub, Instagram feeds
- Over 400 data source plugins:

https://www.gatsbyjs.org/plugins/?=source


---

<FullScreenCode style="z-index:10">

```js

// gatsby-config.js

module.exports = {
  siteMetadata: {
    title: `AgilityNerd`,
    author: `Steve Schwarz`,
    subtitle: `Putting the nerd in dog agility since 2004`,
    email: `steve@agilitynerd.com`,
    siteUrl: `https://agilitynerd.com/`,

  },
  plugins: [
    // data source plugins
    {
      resolve: `gatsby-source-filesystem`,
      options: {
        path: `${__dirname}/content/uploads`,
        name: `uploads`,
      },
    },
    {
      resolve: `gatsby-source-filesystem`,
      options: {
        path: `${__dirname}/content/blog/src`,
        name: `blog`,
      },
    },
    // transformation plugins
    {
      resolve: `gatsby-plugin-mdx`,
      options: {
        extensions: [`.mdx`, `.md`],
        gatsbyRemarkPlugins: [
          {
            resolve: `gatsby-remark-images`,
            options: {
              maxWidth: 2000,
              showCaptions: ['title', 'alt'],
            },
          },
        ]
      }
    },



```
</FullScreenCode>

---

## Use GraphQL to Access Data

[GraphiQL](http://localhost:8000/___graphql?query=query%20MyQuery%20%7B%0A%20%20allMdx(sort%3A%20%7Bfields%3A%20%5Bfrontmatter___date%5D%2C%20order%3A%20DESC%7D%2C%20filter%3A%20%7Bfrontmatter%3A%20%7Bdate%3A%20%7Bne%3A%20null%7D%2C%20draft%3A%20%7Bne%3A%20true%7D%7D%7D)%20%7B%0A%20%20%20%20edges%20%7B%0A%20%20%20%20%20%20node%20%7B%0A%20%20%20%20%20%20%20%20id%0A%20%20%20%20%20%20%20%20fields%20%7B%0A%20%20%20%20%20%20%20%20%20%20slug%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20frontmatter%20%7B%0A%20%20%20%20%20%20%20%20%20%20title%0A%20%20%20%20%20%20%20%20%20%20date%0A%20%20%20%20%20%20%20%20%20%20tags%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20tagsGroup%3A%20allMdx(filter%3A%20%7Bfrontmatter%3A%20%7Bdate%3A%20%7Bne%3A%20null%7D%2C%20draft%3A%20%7Bne%3A%20true%7D%7D%7D)%20%7B%0A%20%20%20%20group(field%3A%20frontmatter___tags)%20%7B%0A%20%20%20%20%20%20fieldValue%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%0A&operationName=MyQuery)

---

## Generate pages using Gatsby API

- In `gatsby-node.js`:
  - Export `createPages` function that builds all pages
  - Call Gatsby's `createPage()` with GraphQL results

---

<FullScreenCode>

```js
// gatsby-node.js

exports.createPages = async ({ graphql, actions }) => {

  // Get MINIMUM data to pass to template

  const result = await graphql(
    `{
      allMdx(sort: {fields: [frontmatter___date], order: DESC},
      filter: {frontmatter: {date: {ne: null}, draft: {ne: true}}}) {
        edges {
          node {
            id
            fields {
              slug
            }
            frontmatter {
              title
              date
              tags
            }
          }
        }
      }
      tagsGroup: allMdx(
        filter: {frontmatter: {date: {ne: null}, draft: {ne: true}}}) {
        group(field: frontmatter___tags) {
          fieldValue
        }
      }
    }`
  )



```
</FullScreenCode>

---

<FullScreenCode>

```js
// Create individual blog posts pages from query results

const posts = result.data.allMdx.edges

posts.forEach((post, index) => {
  const previous = index === posts.length - 1 ? null : posts[index + 1].node
  const next = index === 0 ? null : posts[index - 1].node
  const slug = post.node.fields.slug

  // Call Gatsby API for each page:

  createPage({
    path: slug,          // URL
    component: blogPost, // template component
    context: {           // template component props
      slug: slug,
      previous,
      next,
    },
  })
})
```

</FullScreenCode>

---

## Template Components

- React components
- Optionally, GraphQL query for more data

---

<FullScreenCode>

```js
// Static GraphQL query run with slug property

export const pageQuery = graphql`
  query BlogPostBySlug($slug: String) {
    site {
      siteMetadata {
        title
        siteUrl
      }
    }
    mdx(fields: {slug: { eq: $slug }}) {
      id
      excerpt
      body
      frontmatter {
        title
        date(formatString: "DD MMM YYYY")
        description
        tags
        author
        image {
          childImageSharp {
            fluid(maxWidth:2000) {
              ...GatsbyImageSharpFluid_withWebp
            }
          }
        }
      }
    }
  }
`


class BlogPostTemplate extends React.Component {

  render() {

    // props extended with GraphQL results

    const { location, path, pageContext, data: { mdx, site: { siteMetadata } } } = this.props

    // snip ...

    return (
      <Layout location={location} image={image}>
        <SEO
          title={mdx.frontmatter.title}
          description={description}
          image={image && image.src}
        />
        <Breadcrumb path={path} disableLast={true} />
        <article>
          <h1 className="mt-5">
            {mdx.frontmatter.title}
          </h1>
          <p className="info">
            <span className="date">{mdx.frontmatter.date}</span>
            <span className="author">{mdx.frontmatter.author}</span>
          </p>
          <MDXRenderer>
            {mdx.body}
          </MDXRenderer>
          <h3>Related Articles:</h3>
          <ul>
            { related.map(r => <li><Link to={r.slug}>{r.title}</Link></li>)}
          </ul>
          <div className="tags my-5">Tags: <TagsList tags={mdx.frontmatter.tags} /></div>
          <AddThis slug={fullUrl} title={mdx.frontmatter.title} description={description} />
          <Disqus config={disqusConfig(fullUrl, mdx.frontmatter.title)} />
        </article>
        <hr className="mb-5" />
        <snip />
      </Layout>
    )
  }
}

export default BlogPostTemplate



```

</FullScreenCode>

---
## React Components Everywhere

Create your own:
  ```
  <TagCloud>
  <TagList>
  <Breadcrumbs>
  <Categories>
  ```

 3rd Party Components

---

## Plugin Power!

<SplitLeftAlign style="width:90%">

<div>

- During generation:
  - Markdown/MDX to HTML
  - RSS Feeds
  - Image Processing
  - Sass
  - Sitemap
  - Robots.txt

</div>

<div>

- Client-side:
  - Analytics
  - Search
  - Comments
  - Offline mode
  - Crash monitoring
  - [1400+ Plugins](https://www.gatsbyjs.org/plugins/)

</div>

</SplitLeftAlign>

---

## Deploy

- Gatsby sites only need static hosting!
- GitHub pages, AWS, Azure, Zeit, Netlify, Cloudflare, Google Cloud, etc.
- Trigger build via Git commit hook
- Auto deploys after build

---

<!--
## Gatsby Themes

- Packages reusable plugins, styling, queries
- More than a traditional "theme"

---

## Gatsby Future

- Gatsby Cloud
- Large site performance

---
-->

## Use Gatsby For:

- Portfolio, brouchure, blogs
- Excels at content obtained at build time
- Hybrid sites: include client side JS to communicate with APIs
- New data? Regenerate and re-deploy

---

## Wait, There's More Gatsby!


- _This slide deck_ is built with Gatsby-based [mdx-deck](https://github.com/jxnblk/mdx-deck) !
- Slide deck source on GitHub:   https://github.com/saschwarz/nwjs-gatsby
- Commit/Push Builds/Deploys to [Netlify](https://netlify.com):

https://nwcjs-gatsby.netlify.com


---
import snapgatsby from './images/snap-gatsby.jpg'

<Image src={snapgatsby} size="contain" style={{height: '80vh'}}>
</Image>

---
